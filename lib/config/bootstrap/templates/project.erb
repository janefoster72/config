set -e

mkdir -p /etc/config

cd /etc/config

if [ ! -d project ]; then
  echo '[cloning project: <%= git_uri %>]'
  git clone <%= git_uri %> project
else
  echo '[project exists]'
  cd project
  git fetch
fi

cd /etc/config/project

echo '[initializing at: <%= git_ref %>]'
git reset --hard <%= git_ref %>

echo '[cloning the database]'
bundle-config exec config-update-database

echo '[starting config-run]'
bundle-config exec config-run
