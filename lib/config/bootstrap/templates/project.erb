set -e

mkdir -p /etc/config

cd /etc/config

if [ ! -d project ]; then
  echo '[cloning project: <%= git_uri %>]'
  git clone <%= git_uri %> project
fi

echo '[installing project scripts]'

echo '#!/bin/bash
set -e
cd /etc/config/project
<%= update_project_script %>
bundle-config install
bundle-config exec config-update-database
bundle-config exec config-exec-node
' > /usr/local/sbin/config-global-update

echo '!#/bin/bash
set -e
if [ -f /etc/config/disabled ]; then
  echo 'config is disabled. Remove /etc/config/disabled to enable' >&2
  exit 1
else
  flock -o -n /var/lock/config.lock -c config-global-update
fi
' > /usr/local/sbin/config-run

chmod 755 /usr/local/sbin/config-global-update
chmod 755 /usr/local/sbin/config-run

# TODO: We might want to add a --bootstrap flag to config-run
# to indicate that this node should NOT exist. Otherwise you
# might be creating a duplicate node. If we did that, we'd want
# to call config-run with/without --bootstrap as appropriate, 
# probably dependent on the project existing?

echo '[starting config-run]'
config-run
