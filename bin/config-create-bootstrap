#!/usr/bin/env ruby

require 'config'
require 'tempfile'

blueprint_name = File.basename($0)

usage = "usage: config-create-bootstrap CLUSTER BLUEPRINT IDENTITY"

cluster   = ARGV.shift or abort usage
blueprint = ARGV.shift or abort usage
identity  = ARGV.shift or abort usage

project = Config::Project.new(Dir.pwd)
project.require_all

project.clusters[cluster] or abort "Unknown cluster: #{cluster}"
project.blueprints[blueprint] or abort "Unknown blueprint: #{blueprint}"

identity_file = Tempfile.new("identity")
system_file = Tempfile.new("system")
access_file = Tempfile.new("access")
project_file = Tempfile.new("project")

Config.log_to StringIO.new
Config.blueprint(blueprint_name) do

  # Install system dependencies.
  add Config::Bootstrap::System do |p|
    p.path = system_file
    # TODO: set ruby,bundler,git versions
  end

  # Establish the identity of the server.
  add Config::Bootstrap::Identity do |p|
    p.path = identity_file
    p.cluster = cluster
    p.blueprint = blueprint
    p.identity = identity
    # TODO: allow secret to be configured per cluster.
    p.secret = project.data_dir.secret(:default).read
  end

  # Provide access to the git repos.
  add Config::Bootstrap::Access do |p|
    p.path = access_file
    p.ssh_host = project.hub.git_ssh_host
    p.ssh_port = project.hub.git_ssh_port
    p.ssh_user = project.hub.git_ssh_user
    # TODO: allow more than one ssh key?
    p.ssh_key  = project.data_dir.git_ssh_key.read
  end

  # Initialize and run the project.
  add Config::Bootstrap::Project do |p|
    p.path = project_file
    p.git_uri = project.hub.git_project_url
    # TODO: someday we will have branching.
    p.git_ref = "origin/master"
  end
end

# Abort on any error.
puts "set -e"

# Show each command that's run.
puts "set -x" # TODO: only enable -x if a debug option is set?

puts
puts "echo; echo '[System]'"
puts system_file.read
puts
puts "echo; echo '[Identity]'"
puts identity_file.read
puts
puts "echo; echo '[Access]'"
puts access_file.read
puts
puts "echo; echo '[Project]'"
puts project_file.read

