#!/usr/bin/env ruby

require 'config'
require 'tempfile'

blueprint_name = File.basename($0)

usage = "usage: config-create-bootstrap CLUSTER BLUEPRINT IDENTITY"

cluster   = ARGV.shift or abort usage
blueprint = ARGV.shift or abort usage
identity  = ARGV.shift or abort usage

project = Config::Project.new(Dir.pwd)
project.require_all

project.clusters[cluster] or abort "Unknown cluster: #{cluster}"
project.blueprints[blueprint] or abort "Unknown blueprint: #{blueprint}"

identity_file = Tempfile.new("identity")
system_file = Tempfile.new("system")
project_file = Tempfile.new("project")

Config.log_to StringIO.new
Config.blueprint(blueprint_name) do

  add Config::Bootstrap::System do |p|
    p.path = system_file
    # TODO: set ruby,bundler,git versions
  end

  add Config::Bootstrap::Identity do |p|
    p.path = identity_file
    p.cluster = cluster
    p.blueprint = blueprint
    p.identity = identity
    # TODO: set secret
    p.secret = "SECRET"
  end

  add Config::Bootstrap::Project do |p|
    p.path = project_file
    # TODO: set git vars to real values.
    p.git_uri = project.hub.git_project
    p.git_ref = "origin/master"
  end
end

# Abort on any error.
puts "set -e"

# Show each command that's run.
puts "set -x" # TODO: only enable -x if a debug option is set?

puts
puts "echo '[System]'"
puts system_file.read
puts
puts "echo '[Identity]'"
puts identity_file.read
puts
puts "echo '[Project]'"
puts project_file.read

