#!/usr/bin/env ruby

#
# First we fork and self update the project.
#

pid = fork {
  require 'config'

  Config.log_to $stdout

  project = Config.project
  status = project.git_repo.update

  case status
  when :dirty
    puts "Git repo is not totally clean"
    exit 1
  when :updated
    `bundle install`
    project.database.update
  end
}

Process.wait(pid)
exit $? unless $? == 0

#
# Now we can run with the latest version.
#

require 'config'

Config.log_to $stdout

project = Config.project

fqn = ARGV.shift || project.data_dir.fqn

abort "Missing FQN to identify the Node" unless fqn

project.update_node!(fqn)
project.execute_node!(fqn)

